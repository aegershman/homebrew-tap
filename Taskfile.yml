version: "2"

vars:
  GH_ORG: '{{.GH_ORG | default "override_me"}}'
  GH_REPO: '{{.GH_REPO | default "override_me"}}'
  VERSION: '{{.VERSION | default "v0.0.0"}}'
  ARTIFACT: '{{.ARTIFACT | default "x-darwin-amd64"}}'
  URL: https://github.com/{{.GH_ORG}}/{{.GH_REPO}}/releases/download/{{.VERSION}}/{{.ARTIFACT}}
  TAP_RUBY_FILE: '{{.TAP_RUBY_FILE | default "x-darwin-amd64.rb"}}'

tasks:
  fetch:
    cmds:
      - |
        fetch --repo="https://github.com/gruntwork-io/fetch" \
          --tag="~>v0.3" \
          --release-asset="fetch_darwin_amd64" .

  create:
    desc: create a new tap based on current env files
    vars:
      URL: '{{.URL | default ""}}'
      TAP: aegershman/homebrew-tap
    cmds:
      - brew tap {{.TAP}}
      - brew create {{.URL}} --tap {{.TAP}} || true
      - |
        cd $(brew --repo {{.TAP}})
        git remote set-url origin git@github.com:{{.TAP}}.git

  clean:
    desc: remove any amd64 binaries in working directory
    cmds:
      - rm *amd64*

  commit:
    desc: autocommit; pretty gross, but whatever
    cmds:
      - git add -A
      - git commit -m "autocommit"

  update:
    desc: lifecycle of downloading github release binary and update it's tap.rb file
    cmds:
      - task: download
      - task: replace

  download:
    desc: download the github release binary
    vars:
      VERSION: '{{.VERSION | default ""}}'
      ARTIFACT: '{{.ARTIFACT | default ""}}'
      URL: '{{.URL | default ""}}'
    status:
      - test -f {{.ARTIFACT}}
    cmds:
      - curl --location --silent {{.URL}} --output {{.ARTIFACT}}

  replace:
    desc: update tap.rb with sha256 and version file
    vars:
      ARTIFACT: '{{.ARTIFACT | default ""}}'
      TAP_RUBY_FILE: '{{.TAP_RUBY_FILE | default ""}}'
      VERSION: '{{.VERSION | default ""}}'
    preconditions:
      - test -f {{.ARTIFACT}}
    cmds:
      - |
        SHASUM=$(shasum -a 256 {{.ARTIFACT}} | cut -d ' ' -f 1)
        sed -i '' -e "s/sha256 \\\".*\\\"/sha256 \\\"${SHASUM}\\\"/" {{.TAP_RUBY_FILE}}
        sed -i '' -e "s/v = \\\".*\\\"/v = \\\"{{.VERSION}}\\\"/" {{.TAP_RUBY_FILE}}
